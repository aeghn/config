#!/usr/bin/env bash

FILEPATH="$(realpath --no-symlinks "$1")"

CONFIG_ISLAND_DIR="$HOME/files/config"

RELATIONS=(
    path "$HOME/.emacs.d" "emacs"
    base "$HOME/.config" "/"
)

dfs_store() {
    local method prefix relative suffix
    for ((i=0; i < ${#RELATIONS}; i=i+3)); do
        method="${RELATIONS[i]}"
        prefix="${RELATIONS[i+1]%/}/"
        relative="${RELATIONS[i+2]}"
        config_dir="${CONFIG_ISLAND_DIR%/}"

        if echo "$FILEPATH" | grep "^$(realpath --no-symlink "$prefix")/" &>/dev/null; then
            mainland="${FILEPATH}"
            if [ "$method" = base ]; then
                suffix="${FILEPATH/$prefix/}"
                dir_name="${suffix%/*}"

                island="$config_dir/$suffix"
                dfs="$config_dir/$dir_name/.dfs"
            elif [ "$method" = path ]; then
                suffix="${FILEPATH/$prefix/}"
                island="${config_dir}/$relative/$suffix"
                dfs="$config_dir/$relative/.dfs"
            fi

            dfm "$island" "$mainland" -f "$dfs"
            break
        fi
    done
}

dfs_restore() {
    :
}

if echo "$FILEPATH" | grep "^$(realpath --no-symlink "$CONFIG_ISLAND_DIR")/" &>/dev/null; then
    dfs_restore
else
    dfs_store
fi
