#!/usr/bin/env bash


can_handle() {
	[[ "$FILEPATH" =~ "$1" ]] && return 0 || return 122
}

dfs_home_dotsciprts() {
    # We check if this function could handle the path.
    can_handle "$HOME/.scripts/" "$0" || return 122

    local filename="${FILEPATH##*/}"
    local island_file="${CONFIG_ISLAND_DIR%/}/scripts/$filename"
    dfm "$island_file" "$FILEPATH"
}

dfs_home_dotconfig() {
    can_handle "$HOME/.config/" "$0" || return 122

}


fullpath() {
    awk -v target="$1" -v pwd="$PWD" 'BEGIN { t=target;c=pwd;if(substr(t,1,1)!="/"){t=c"/"t;}gsub("/\\.?/","/",t);while(match(t,"/[^./]+/\\.\\./")){t=substr(t,1,RSTART-1)"/"substr(t,RSTART+RLENGTH);}print t; }'
}


for i in "$@"; do
	FILEPATH="$(fullpath "$i")"

	CONFIG_ISLAND_DIR="$HOME/files/config"
	echo "==> FILEPATH: $FILEPATH"
	for func in $(compgen -A function); do
		if [[ ! "$func" =~ dfs_.* ]]; then
			continue
		fi
		echo "=> Try: $func"
		eval "$func"
		exit_status="$?"
		if [ "_$exit_status" = _122 ]; then
			continue
		elif [ "_$exit_status" != _0 ]; then
			echo "unknown exit status: $exit_status"
			exit 1
		fi
	done
	echo "==========================="
done
