#!/usr/bin/env python3
import sys

def extract_block_from_lines(lines, target_prefix):
    """
    Extract the first block that starts with target_prefix (after stripping leading/trailing whitespace).
    Handles nested braces and ignores braces inside single/double quoted strings (with escaping).
    Returns the block as a string, or None if not found.
    """
    in_block = False
    brace_level = 0
    result_lines = []

    for line in lines:
        stripped = line.strip().rstrip('\r\n').strip()  # only strip for matching, keep original line

        if not in_block:
            # Check if this line starts with the target prefix
            if stripped.startswith(target_prefix):
                print(f"{stripped} -- {target_prefix}")
                # Ensure it's a complete token match: either end of line or followed by space/'{'
                after_prefix = stripped[len(target_prefix):]
                if not after_prefix or after_prefix[0] in (' ', '\t', '{'):
                    in_block = True
                    result_lines.append(line)
                    brace_level += count_net_braces(line)
                    if brace_level <= 0:
                        # Edge case: something like "key {}" on one line
                        if brace_level == 0:
                            return ''.join(result_lines)
                        else:
                            # Unmatched }, should not happen in valid config
                            return None
        else:
            result_lines.append(line)
            brace_level += count_net_braces(line)
            if brace_level == 0:
                return ''.join(result_lines)
            if brace_level < 0:
                # Unmatched closing brace â€” invalid, but we stop anyway
                return ''.join(result_lines)

    return ''.join(result_lines) if in_block and brace_level == 0 else None

def count_net_braces(line):
    """
    Count net braces ({ = +1, } = -1) outside of quotes.
    Respects escaping with backslash.
    """
    in_single = False
    in_double = False
    escaped = False
    net = 0

    for char in line:
        if escaped:
            escaped = False
            continue

        if char == '\\':
            escaped = True
            continue

        if char == "'" and not in_double:
            in_single = not in_single
        elif char == '"' and not in_single:
            in_double = not in_double
        elif not in_single and not in_double:
            if char == '{':
                net += 1
            elif char == '}':
                net -= 1

    return net

def main():
    if len(sys.argv) != 2:
        print("Usage: python3 extract_block.py 'keyword ss'", file=sys.stderr)
        print("Reads config from stdin, extracts the block starting with the given prefix.", file=sys.stderr)
        sys.exit(1)

    target_prefix = sys.argv[1]

    # Read all input from stdin
    try:
        content = sys.stdin.read()
    except KeyboardInterrupt:
        sys.exit(1)

    lines = content.splitlines(keepends=True)
    block = extract_block_from_lines(lines, target_prefix)

    if block is not None:
        sys.stdout.write(block)
    else:
        print(f"Block starting with '{target_prefix}' not found.", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    main()
